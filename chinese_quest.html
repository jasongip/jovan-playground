<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jovan's Chinese Quest: Cloud RPG</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8Z53DTDB23"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-8Z53DTDB23');
    </script>

    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'VT323', "Kaiti TC", "STKaiti", "BiauKai", "Apple LiSung", "æ¨™æ¥·é«”", "DFKai-SB", sans-serif; 
            background-color: #5c3c21; 
            background-image: repeating-conic-gradient(#5c3c21 0% 25%, #4e341c 0% 50%);
            background-size: 40px 40px; color: #fff; padding: 10px; text-align: center; overflow: hidden;
        }

        /* RPG è‹±é›„ç‹€æ…‹æ¬„æ¨£å¼ (æ¨™æº–å¥—è£) */
        #hero-status {
            background: #3d2b1f; border: 4px solid #1a120c; border-radius: 15px;
            max-width: 600px; margin: 0 auto 15px; padding: 12px; text-align: center;
            color: #fff; box-shadow: 0 6px 0 #000;
        }
        #hero-name { color: #FFFF55; font-size: 1.8em; text-shadow: 2px 2px #000; margin-bottom: 5px; }
        .global-xp-display { color: #55FF55; font-size: 1.4em; }

        /* XP Bar æ¨£å¼ */
        #xp-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 25px; background: #222; border-top: 4px solid #000; z-index: 2000; }
        #xp-bar { height: 100%; width: 0%; background: #55FF55; transition: width 0.5s ease; box-shadow: inset 0 5px 10px rgba(255,255,255,0.3); }
        #xp-text { position: absolute; top: -28px; left: 50%; transform: translateX(-50%); color: #55FF55; font-size: 1.6em; text-shadow: 2px 2px #000; font-weight: bold; }

        /* TNT Combo æ¨£å¼ */
        #tnt-box { position: fixed; bottom: 45px; right: 20px; width: 80px; height: 80px; z-index: 1500; display: none; }
        .tnt-sprite { 
            width: 100%; height: 100%; background: #d32f2f; border: 4px solid #000; 
            display: flex; align-items: center; justify-content: center; font-size: 1.5em; font-weight: bold; color: #fff;
            box-shadow: 4px 4px 0 #000;
        }
        .combo-count { position: absolute; top: -25px; left: 0; width: 100%; color: #ffff55; font-size: 1.8em; text-shadow: 2px 2px #000; }

        @keyframes explode {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.4); filter: brightness(3); }
            100% { transform: scale(0); opacity: 0; }
        }
        .exploding { animation: explode 0.5s forwards; }

        #help-btn { position: fixed; top: 10px; left: 10px; background: #f1c40f; border: 3px solid #fff; border-radius: 50%; width: 40px; height: 40px; line-height: 40px; font-size: 1.5em; cursor: pointer; z-index: 2000; box-shadow: 3px 3px 0 #000; }
        #tooltip-content { display: none; position: fixed; top: 60px; left: 10px; background: rgba(0,0,0,0.9); border: 2px solid #55FF55; padding: 15px; width: 280px; text-align: left; font-size: 1.1em; z-index: 2000; box-shadow: 5px 5px 0 #000; line-height: 1.4; }
        #counter-group { position: fixed; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 1000; }
        .counter-tag { background: rgba(0,0,0,0.8); border: 2px solid #55FF55; padding: 5px 12px; font-size: 1.4em; color: #FFFF55; text-align: right; }
        .dictation-tag { border-color: #f1c40f; color: #f1c40f; }
        .mode-switch { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }
        .mode-btn { padding: 6px 15px; font-family: 'VT323', sans-serif; cursor: pointer; background: #777; border: 3px solid #333; color: #fff; font-size: 1.2em; }
        .mode-active { background: #3498db !important; border-color: #fff !important; }
        h1 { color: #55FF55; text-shadow: 3px 3px #000; font-size: 2.2em; margin: 5px 0; }
        .canvas-area { position: relative; background: #fff; border: 8px solid #3d2b1f; width: 320px; height: 320px; margin: 10px auto; touch-action: none; }
        canvas { position: absolute; top: 0; left: 0; cursor: crosshair; }
        #templateCanvas { z-index: 1; opacity: 0.15; }
        #drawCanvas { z-index: 2; }
        .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; }
        .btn { padding: 10px 15px; font-family: 'VT323', sans-serif; font-size: 1.3em; cursor: pointer; border: 4px solid #333; border-bottom-width: 6px; color: #fff; display: flex; align-items: center; gap: 5px; }
        .btn-speak { background: #f1c40f; color: #000; }
        .btn-check { background: #4aa02c; }
        .btn-clear { background: #e74c3c; }
        .btn-next { background: #3498db; }
        #targetWord { color: #55FF55; font-size: 1.8em; cursor: pointer; border-bottom: 2px dashed #FFFF55; padding: 0 10px; }
        #message { font-size: 1.6em; margin-top: 5px; color: #FFFF55; text-shadow: 2px 2px #000; min-height: 1.2em; }
        #steve-reward { position: fixed; bottom: -200px; left: 50%; transform: translateX(-50%); transition: 0.5s; z-index: 100; pointer-events: none; }
        .show-steve { bottom: 45px !important; }

        @keyframes fadeUp {
            0% { transform: translate(-50%, 0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(-50%, -100px); opacity: 0; }
        }
    </style>
</head>
<body>

<div id="help-btn" onclick="toggleTooltip()">ğŸ’¡</div>
<div id="tooltip-content">
    <b>iPad å»£æ±è©±èªéŸ³è¨­å®šï¼š</b><br>
    1. Settings -> 2. Accessibility -> 3. Spoken Content -> 4. Voices -> 5. Chinese -> 6. Cantonese -> 7. Sin-Ji (Premium)
</div>

<div id="counter-group">
    <div class="counter-tag">ç·´ç¿’ç¸½æ•¸: <span id="practiceCount">0</span></div>
    <div class="counter-tag dictation-tag">è½é»˜æ­£è§£: <span id="dictationCount">0</span></div>
</div>

<div id="hero-status">
    <div id="hero-name">Loading Identity...</div>
    <div class="global-xp-display">TOTAL XP: <span id="display-xp">0</span></div>
</div>

<div class="container">
    <div class="mode-switch">
        <button id="modePractice" class="mode-btn mode-active" onclick="setMode('practice')">ç·´ç¿’æ¨¡å¼ (60%)</button>
        <button id="modeDictation" class="mode-btn" onclick="setMode('dictation')">è½é»˜æ¨¡å¼ (40%)</button>
    </div>
    <h1>ğŸ‘¾ CHINESE 145 QUEST PRO ğŸ‘¾</h1>
    <div id="word-display-box">
        <span id="promptText">è«‹å¯«å‡ºï¼š</span>
        <span id="targetWord" onclick="revealHint()"></span>
        <button class="btn btn-speak" onclick="speakWord()" style="display:inline-flex; vertical-align:middle; padding:5px 10px; margin-left:10px;">ğŸ”Š è½éŸ³</button>
    </div>
    <div class="canvas-area">
        <canvas id="templateCanvas" width="320" height="320"></canvas>
        <canvas id="drawCanvas" width="320" height="320"></canvas>
    </div>
    <div id="message">æº–å‚™æŒ‘æˆ° 145 å€‹ç”Ÿå­—ï¼</div>
    <div class="btn-group">
        <button class="btn btn-clear" onclick="clearCanvas()">ğŸ—‘ï¸ é‡å¯«</button>
        <button class="btn btn-check" onclick="checkWriting()">âœ… æª¢æŸ¥</button>
        <button class="btn btn-next" onclick="initGame()">â­ï¸ ä¸‹ä¸€å­—</button>
    </div>
</div>

<div id="xp-container">
    <div id="xp-text">LEVEL 1</div>
    <div id="xp-bar"></div>
</div>

<div id="tnt-box">
    <div class="combo-count" id="comboText">COMBO x0</div>
    <div class="tnt-sprite" id="tntImg">TNT</div>
</div>

<div id="steve-reward">
    <svg width="100" height="150" viewBox="0 0 100 150">
        <rect x="25" y="0" width="50" height="50" fill="#EBD2B2" stroke="#000" stroke-width="2"/>
        <rect x="20" y="50" width="60" height="60" fill="#00AFAF" stroke="#000" stroke-width="2"/>
        <rect x="25" y="110" width="20" height="40" fill="#4040FF" stroke="#000" stroke-width="2"/>
        <rect x="55" y="110" width="20" height="40" fill="#4040FF" stroke="#000" stroke-width="2"/>
        <text x="10" y="40" font-size="30">ğŸ’</text>
    </svg>
</div>

<script type="module">
    import { db, doc, setDoc } from './firebase-config.js';

    const wordBank = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å", "ç™¾", "åƒ", "ä¸Š", "ä¸‹", "å·¦", "å³", "å¤§", "å°", "å¤š", "å°‘", "äºº", "å£", "æ‰‹", "è¶³", "ç›®", "è€³", "å¿ƒ", "é ­", "å±±", "æ°´", "æœ¨", "ç¦¾", "åœŸ", "æ—¥", "æœˆ", "å¤©", "ç«", "é¢¨", "é›¨", "é›»", "æ˜¥", "å¤", "ç§‹", "å†¬", "çˆ¸", "åª½", "å“¥", "å§", "å¼Ÿ", "å¦¹", "ç”·", "å¥³", "è€", "å°‘", "å¸«", "ç”Ÿ", "å‹", "å…¬", "å©†", "æ ¡", "å®¶", "é–€", "çª—", "åºŠ", "æ¤…", "æ¡Œ", "ç‡ˆ", "ç­†", "æ›¸", "ç´™", "ç•«", "æ­Œ", "èŠ±", "è‰", "æ¨¹", "è‘‰", "æœ", "ç±³", "è‚‰", "è±†", "ç‰›", "ç¾Š", "é¦¬", "é›", "ç‹—", "è²“", "é­š", "é³¥", "ä¸­", "åœ‹", "é¦™", "æ¸¯", "å‡º", "å…¥", "é–‹", "é—œ", "ä¾†", "å»", "å", "ç«‹", "èµ°", "è·‘", "è·³", "é£›", "è½", "èªª", "è®€", "å¯«", "çœ‹", "è¦‹", "æ—©", "åˆ", "æ™š", "ç´…", "é»ƒ", "è—", "ç¶ ", "ç™½", "é»‘", "é‡‘", "æˆ‘", "çˆ¶", "æ¯", "é›²", "å–®", "è»Š", "ä¼‘", "çŸ³", "çš„", "æ˜¯", "çƒ", "åš", "æœƒ", "æœ‹", "å€‘", "åŠ›", "ç‰", "çŠ¬", "ç‹", "æ˜", "å¤", "è¡£", "å¼“", "å·¾", "åœ°"];

    let currentWord = "", currentMode = 'practice';
    let practiceCorrect = 0, dictationCorrect = 0, isHintRevealed = false;
    let streak = 0, xp = 0, level = 1;
    let isXpAwarded = false; // ç´€éŒ„å‘¢å€‹å­—åŠ å’—åˆ†æœª

    const kaitiFont = '"Kaiti TC", "STKaiti", "BiauKai", "æ¥·é«”", sans-serif';
    const tCanvas = document.getElementById('templateCanvas'), dCanvas = document.getElementById('drawCanvas');
    const tCtx = tCanvas.getContext('2d'), dCtx = dCanvas.getContext('2d');
    let drawing = false;

    function safeUpdateText(id, text) {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    }

    function initHero() {
        const name = localStorage.getItem('jovan_hero_name') || "Mystery Explorer";
        const globalXp = localStorage.getItem('jovan_total_xp') || 0;
        safeUpdateText('hero-name', name);
        safeUpdateText('display-xp', globalXp);
    }

    async function addGlobalXP(amount) {
        let currentXP = parseInt(localStorage.getItem('jovan_total_xp')) || 0;
        let heroName = localStorage.getItem('jovan_hero_name') || "Mystery Explorer";
        currentXP += amount;
        localStorage.setItem('jovan_total_xp', currentXP);
        safeUpdateText('display-xp', currentXP);

        const msg = document.createElement('div');
        msg.innerText = `+${amount} XP!`;
        msg.style = "position:fixed; top:40%; left:50%; transform:translateX(-50%); font-size:4em; color:#55FF55; text-shadow:3px 3px #000; z-index:9999; pointer-events:none; animation: fadeUp 1.5s forwards;";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 1500);

        try {
            await setDoc(doc(db, "leaderboard", heroName), {
                name: heroName, xp: currentXP, lastUpdate: new Date()
            }, { merge: true });
        } catch (e) { console.error("Cloud Sync Error:", e); }
    }

    window.toggleTooltip = function() {
        const content = document.getElementById('tooltip-content');
        if(content) content.style.display = (content.style.display === 'block') ? 'none' : 'block';
    };

    window.setMode = function(mode) { currentMode = mode; initGame(); };
    
    window.speakWord = function() { 
        if (!currentWord) return; 
        const msg = new SpeechSynthesisUtterance(currentWord); 
        msg.lang = 'zh-HK'; msg.rate = 0.7; 
        window.speechSynthesis.speak(msg); 
    };
    
    window.revealHint = function() { 
        if (currentMode === 'dictation') { 
            document.getElementById('targetWord').innerText = currentWord; 
            document.getElementById('targetWord').style.color = "#FFFF55"; 
            isHintRevealed = true;
            streak = 0; updateComboUI();
        } 
    };

    window.initGame = function() {
        initHero();
        isXpAwarded = false; // é‡è¦ï¼šæ›æ–°å­—ï¼Œé‡è¨­çå‹µé–
        currentWord = wordBank[Math.floor(Math.random() * wordBank.length)];
        isHintRevealed = false;
        const targetWordEl = document.getElementById('targetWord');
        const tCanvasEl = document.getElementById('templateCanvas');
        if (currentMode === 'dictation') {
            targetWordEl.innerText = "???"; tCanvasEl.style.opacity = "0"; 
            safeUpdateText('promptText', "è½éŸ³é»˜å¯«ï¼š");
            safeUpdateText('message', "ç‡å’—æç¤ºå””è¨ˆåˆ†åŒæ–· Combo ã—ï¼");
        } else {
            targetWordEl.innerText = currentWord; tCanvasEl.style.opacity = "0.15"; 
            safeUpdateText('promptText', "è«‹å¯«å‡ºï¼š");
            safeUpdateText('message', "ç·´ç¿’æ¨¡å¼ï¼ŒåŠ æ²¹ï¼");
        }
        tCtx.clearRect(0, 0, 320, 320); tCtx.fillStyle = "#cccccc"; tCtx.font = "220px " + kaitiFont; tCtx.textAlign = "center"; tCtx.textBaseline = "middle"; tCtx.fillText(currentWord, 160, 165);
        clearCanvas(); setupDrawing();
    };

    window.clearCanvas = function() { 
        dCtx.clearRect(0, 0, 320, 320); 
        const reward = document.getElementById('steve-reward');
        if(reward) reward.classList.remove('show-steve'); 
    };

window.checkWriting = function() {
    const tD = tCtx.getImageData(0, 0, 320, 320).data, dD = dCtx.getImageData(0, 0, 320, 320).data;
    let tP = 0, mP = 0;
    for (let i = 3; i < tD.length; i += 4) { if (tD[i] > 10) { tP++; if (dD[i] > 10) mP++; } }
    const score = (mP / tP) * 100;
    const threshold = (currentMode === 'dictation') ? 40 : 60;
    
    if (score >= threshold) {
        safeUpdateText('message', `å¥½å‹å‘€ï¼${Math.round(score)}% ä¼¼ï¼ğŸ’`);
        document.getElementById('steve-reward').classList.add('show-steve');
        
        // --- æ ¸å¿ƒé˜²åˆ·åˆ† Logic ---
        if (!isXpAwarded) {
            if (currentMode === 'dictation') {
                if (!isHintRevealed) {
                    dictationCorrect++; safeUpdateText('dictationCount', dictationCorrect);
                    streak++; 
                    addGlobalXP(3); // è½é»˜ +3 XP
                } else {
                    document.getElementById('message').innerText += " (ç‡å’—æç¤ºå””è¨ˆåˆ†)";
                    streak = 0;
                }
            } else {
                practiceCorrect++; safeUpdateText('practiceCount', practiceCorrect);
                streak = 0; 
                addGlobalXP(1); // ç·´ç¿’ +1 XP
            }
            
            // æœ¬åœ° Level Up XP ç…§åŠ  (å› ç‚ºå‘¢å€‹ä¿‚ Session å…§å˜…ï¼Œå””å½±éŸ¿æ’åæ¦œ)
            xp += 20;
            if (xp >= 100) { 
                level++; xp = 0; 
                safeUpdateText('xp-text', "LEVEL " + level + " UP!"); 
                setTimeout(() => safeUpdateText('xp-text', "LEVEL " + level), 2000); 
            }
            
            isXpAwarded = true; // é–æ­»ï¼šå‘¢å€‹å­—å˜… Global XP å·²ç¶“æ”å’—å–‡ï¼
        } else {
            document.getElementById('message').innerText += " (Score checked!)";
        }
        // -----------------------

        updateXPUI(); updateComboUI();
        if (streak >= 5) triggerTNT();
        speakWord();
        setTimeout(() => { if(confirm("å¤§å‹åˆ©ï¼ä¸‹ä¸€å€‹ï¼Ÿ")) initGame(); }, 1200);
    } else {
        safeUpdateText('message', `å¾— ${Math.round(score)}%... å†è©¦ä¸‹ï¼`);
        streak = 0; updateComboUI();
    }
};

    function setupDrawing() {
        dCtx.strokeStyle = "#222"; dCtx.lineWidth = 18; dCtx.lineCap = "round"; dCtx.lineJoin = "round";
        const getPos = (e) => {
            const rect = dCanvas.getBoundingClientRect();
            const cx = (e.clientX || (e.touches && e.touches[0].clientX));
            const cy = (e.clientY || (e.touches && e.touches[0].clientY));
            return { x: cx - rect.left, y: cy - rect.top };
        };
        const start = (e) => { drawing = true; const p = getPos(e); dCtx.beginPath(); dCtx.moveTo(p.x, p.y); };
        const move = (e) => { if (!drawing) return; const p = getPos(e); dCtx.lineTo(p.x, p.y); dCtx.stroke(); if(e.cancelable) e.preventDefault(); };
        const stop = () => { drawing = false; };
        dCanvas.onmousedown = dCanvas.ontouchstart = start; window.onmousemove = window.ontouchmove = move; window.onmouseup = window.ontouchend = stop;
    }

    function updateXPUI() { const bar = document.getElementById('xp-bar'); if(bar) bar.style.width = xp + "%"; }
    function updateComboUI() {
        const tntBox = document.getElementById('tnt-box');
        if (streak > 0) { if(tntBox) tntBox.style.display = 'block'; safeUpdateText('comboText', "COMBO x" + streak); }
        else { if(tntBox) tntBox.style.display = 'none'; }
    }
    function triggerTNT() {
        const tnt = document.getElementById('tntImg'); if(tnt) tnt.classList.add('exploding');
        safeUpdateText('message', "ğŸ’¥ BOOM! 5-COMBO çå‹µï¼ ğŸ’¥");
        spawnDiamonds(); addGlobalXP(5); // TNT +5
        setTimeout(() => { if(tnt) tnt.classList.remove('exploding'); streak = 0; updateComboUI(); }, 1000);
    }
    function spawnDiamonds() {
        for (let i = 0; i < 30; i++) {
            setTimeout(() => {
                const d = document.createElement('div');
                d.innerHTML = "ğŸ’"; d.style.position = "fixed"; d.style.top = "-50px";
                d.style.left = Math.random() * 100 + "vw"; d.style.fontSize = "30px";
                d.style.zIndex = "3000"; d.style.transition = "transform 2s linear, opacity 2s";
                document.body.appendChild(d);
                setTimeout(() => { d.style.transform = "translateY(110vh) rotate(360deg)"; d.style.opacity = "0"; }, 100);
                setTimeout(() => d.remove(), 2500);
            }, i * 100);
        }
    }
    window.onload = initGame;
</script>
</body>
</html>
