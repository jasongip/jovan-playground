<script type="module">
    // 1. 引入 Firebase
    import { db, doc, setDoc } from './firebase-config.js';

    let questions = [];
    let timeLeft = 120;
    let timerInterval = null;

    // 2. 核心功能掛載去 window (重要：咁樣 HTML 啲 onclick 先搵到)
    window.toggleSettings = function() {
        const panel = document.getElementById('settings-panel');
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    };

    window.resetGame = function() {
        timeLeft = 120;
        document.getElementById('timer').classList.remove('time-over');
        const scoreBox = document.getElementById('score-box');
        if(scoreBox) scoreBox.innerHTML = "";
        init();
    };

    window.checkAll = function() {
        let score = 0;
        questions.forEach((d, i) => {
            const inputEl = document.getElementById(`ans-${i}`);
            const val = parseInt(inputEl.value);
            inputEl.classList.remove('correct', 'wrong');
            if (val === d.ans) { score++; inputEl.classList.add('correct'); }
            else { inputEl.classList.add('wrong'); }
        });
        document.getElementById('score-box').innerHTML = "SCORE: " + score + " / 20";
        
        if (score === 20) {
            clearInterval(timerInterval);
            startHeroStampede();
            if (timeLeft > 0) spawnFriedChicken();
            addXP(20); // 滿分加分
        } else {
            const fw = document.querySelector('.wrong');
            if (fw) fw.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    };

    // 3. 雲端加分邏輯
    async function addXP(amount) {
        let currentXP = parseInt(localStorage.getItem('jovan_total_xp')) || 0;
        let heroName = localStorage.getItem('jovan_hero_name') || "Mystery Explorer";
        currentXP += amount;
        localStorage.setItem('jovan_total_xp', currentXP);
        if(document.getElementById('display-xp')) document.getElementById('display-xp').innerText = currentXP;

        // 彈出 XP 字樣
        const msg = document.createElement('div');
        msg.innerText = `+${amount} XP!`;
        msg.style = "position:fixed; top:40%; left:50%; transform:translateX(-50%); font-size:4em; color:#55FF55; text-shadow:3px 3px #000; z-index:9999; pointer-events:none; animation: fadeUp 1.5s forwards;";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 1500);

        try {
            await setDoc(doc(db, "leaderboard", heroName), {
                name: heroName,
                xp: currentXP,
                lastUpdate: new Date()
            }, { merge: true });
            console.log("Cloud Sync Success!");
        } catch (e) { console.error("Cloud Sync Error", e); }
    }

    // 4. 初始化
    function initHero() {
        const name = localStorage.getItem('jovan_hero_name') || "Mystery Explorer";
        const xp = localStorage.getItem('jovan_total_xp') || 0;
        document.getElementById('hero-name').innerText = name;
        document.getElementById('display-xp').innerText = xp;
    }

    function init() {
        initHero();
        const grid = document.getElementById('quizGrid');
        questions = [];
        const opts = document.querySelectorAll('.table-opt:checked');
        const allowedTables = Array.from(opts).map(cb => parseInt(cb.value));
        const finalTables = allowedTables.length > 0 ? allowedTables : [1,2,3,4,5,6,7];

        for (let i = 0; i < 20; i++) {
            const a = finalTables[Math.floor(Math.random() * finalTables.length)];
            const b = Math.floor(Math.random() * 10) + 1;
            questions.push({ q: a + " x " + b, ans: a * b });
        }
        
        grid.innerHTML = questions.map((d, i) => `
            <div class="q-block" id="block-${i}">
                <span class="q-text">${d.q} =</span>
                <input type="number" id="ans-${i}" pattern="[0-9]*">
            </div>
        `).join('');
        startTimer();
    }

    // ... (保留原本嘅 startTimer, startHeroStampede, spawnMob, spawnFriedChicken 內容，但記得搬入黎呢個 <script type="module"> 入面) ...

    window.onload = init;
</script>
</body>
</html>
