<script type="module">
    // 1. ÂºïÂÖ• Firebase
    import { db, doc, setDoc } from './firebase-config.js';

    let questions = [];
    let timeLeft = 120;
    let timerInterval = null;

    // --- Èò≤Á¶¶Ê©üÂà∂ÔºöÊ™¢Êü• ID ÊòØÂê¶Â≠òÂú®ÊâçÊõ¥Êñ∞ÔºåÈÅøÂÖç null Â†±ÈåØ ---
    function safeUpdateText(id, text) {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    }

    // 2. ÂàùÂßãÂåñËã±ÈõÑË≥áÊñô (Èò≤ÊíûÁâà)
    function initHero() {
        const name = localStorage.getItem('jovan_hero_name') || "Mystery Explorer";
        const xp = localStorage.getItem('jovan_total_xp') || 0;
        
        safeUpdateText('hero-name', name);
        safeUpdateText('display-xp', xp);
    }

    // 3. Èõ≤Á´ØÂä†ÂàÜÈÇèËºØ (ÂêåÊ≠•Ëá≥ Firebase)
    async function addXP(amount) {
        let currentXP = parseInt(localStorage.getItem('jovan_total_xp')) || 0;
        let heroName = localStorage.getItem('jovan_hero_name') || "Mystery Explorer";
        
        currentXP += amount;
        localStorage.setItem('jovan_total_xp', currentXP);
        safeUpdateText('display-xp', currentXP);

        // ÂΩàÂá∫ XP ÂãïÁï´
        const msg = document.createElement('div');
        msg.innerText = `+${amount} XP!`;
        msg.style = "position:fixed; top:40%; left:50%; transform:translateX(-50%); font-size:4em; color:#55FF55; text-shadow:3px 3px #000; z-index:9999; pointer-events:none; animation: fadeUp 1.5s forwards;";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 1500);

        try {
            await setDoc(doc(db, "leaderboard", heroName), {
                name: heroName,
                xp: currentXP,
                lastUpdate: new Date()
            }, { merge: true });
            console.log("Math Cloud Sync Success!");
        } catch (e) { 
            console.error("Cloud Sync Error:", e); 
        }
    }

    // 4. ÊéõËºâÊ†∏ÂøÉÂäüËÉΩÂéª window (Á¢∫‰øù HTML onclick ÊêµÂà∞)
    window.toggleSettings = function() {
        const panel = document.getElementById('settings-panel');
        if (panel) panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    };

    window.resetGame = function() {
        timeLeft = 120;
        const timerEl = document.getElementById('timer');
        if (timerEl) timerEl.classList.remove('time-over');
        const scoreBox = document.getElementById('score-box');
        if (scoreBox) scoreBox.innerHTML = "";
        init();
    };

    window.checkAll = function() {
        let score = 0;
        questions.forEach((d, i) => {
            const inputEl = document.getElementById(`ans-${i}`);
            if (inputEl) {
                const val = parseInt(inputEl.value);
                inputEl.classList.remove('correct', 'wrong');
                if (val === d.ans) { score++; inputEl.classList.add('correct'); }
                else { inputEl.classList.add('wrong'); }
            }
        });
        const scoreBox = document.getElementById('score-box');
        if (scoreBox) scoreBox.innerHTML = "SCORE: " + score + " / 20";
        
        if (score === 20) {
            clearInterval(timerInterval);
            if (typeof startHeroStampede === 'function') startHeroStampede();
            if (timeLeft > 0 && typeof spawnFriedChicken === 'function') spawnFriedChicken();
            addXP(20); 
        } else {
            const fw = document.querySelector('.wrong');
            if (fw) fw.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    };

    // 5. ÈÅäÊà≤ÁîüÊàê Logic
    function init() {
        initHero();
        const grid = document.getElementById('quizGrid');
        if (!grid) return;

        questions = [];
        const opts = document.querySelectorAll('.table-opt:checked');
        const allowedTables = Array.from(opts).map(cb => parseInt(cb.value));
        const finalTables = allowedTables.length > 0 ? allowedTables : [1,2,3,4,5,6,7];

        for (let i = 0; i < 20; i++) {
            const a = finalTables[Math.floor(Math.random() * finalTables.length)];
            const b = Math.floor(Math.random() * 10) + 1;
            questions.push({ q: a + " x " + b, ans: a * b });
        }
        
        grid.innerHTML = questions.map((d, i) => `
            <div class="q-block" id="block-${i}">
                <span class="q-text">${d.q} =</span>
                <input type="number" id="ans-${i}" pattern="[0-9]*">
            </div>
        `).join('');
        
        if (typeof startTimer === 'function') startTimer();
    }

    // --- ËºîÂä©ÂãïÁï´ËàáË®àÊôÇÂô® (Êê¨ÂÖ• module ÂÖßÈÉ®) ---
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const timerEl = document.getElementById('timer');
            if (timeLeft > 0 && timerEl) {
                timeLeft--;
                timerEl.innerHTML = timeLeft + "s";
                if (timeLeft === 0) {
                    clearInterval(timerInterval);
                    timerEl.classList.add('time-over');
                    timerEl.innerHTML = "TIME UP!";
                }
            }
        }, 1000);
    }

    function startHeroStampede() {
        const field = document.getElementById('mob-field');
        if (!field) return;
        field.innerHTML = '';
        spawnMob('steve', '<div class="steve-head"><div class="steve-hair"></div><div class="steve-eye"></div></div><div class="steve-body"></div><div class="steve-pants"></div><div class="diamond-sword"></div>', 0, 18);
        const types = [{ class: 'creeper', h: '<div class="creeper-face"></div>' }, { class: 'pig', h: '<div class="pig-eye"></div><div class="pig-nose"></div>' }];
        for (let i = 0; i < 20; i++) {
            const t = types[Math.floor(Math.random() * types.length)];
            spawnMob(t.class, t.h, (i + 1) * 100, Math.random() * 8 + 10);
        }
    }

    function spawnMob(cl, h, delay, spd) {
        const f = document.getElementById('mob-field');
        setTimeout(() => {
            const m = document.createElement('div');
            m.className = 'mob ' + cl; m.innerHTML = h;
            m.style.top = Math.random() * 80 + 5 + 'vh';
            f.appendChild(m);
            let p = -150;
            const mv = setInterval(() => {
                p += spd; m.style.left = p + 'px';
                document.querySelectorAll('.q-block').forEach(b => {
                    const r = b.getBoundingClientRect(); const mr = m.getBoundingClientRect();
                    if (mr.right > r.left && mr.left < r.right && mr.bottom > r.top && mr.top < r.bottom) b.classList.add('destroyed');
                });
                if (p > window.innerWidth + 250) { clearInterval(mv); m.remove(); }
            }, 30);
        }, delay);
    }

    function spawnFriedChicken() {
        for (let i = 0; i < 40; i++) {
            setTimeout(() => {
                const c = document.createElement('div');
                c.className = 'chicken'; c.innerHTML = 'üçó'; 
                c.style.left = Math.random() * 100 + 'vw';
                c.style.animationDuration = (Math.random() * 2 + 1.5) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3500);
            }, i * 100);
        }
    }

    // ÂïüÂãïÔºÅ
    window.onload = init;
</script>
