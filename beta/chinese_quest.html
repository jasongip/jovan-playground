<script type="module">
        // 1. ÂºïÂÖ• Firebase Ë®≠ÂÆö
        import { db, doc, setDoc } from './firebase-config.js';

        const wordBank = ["‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "‰∏É", "ÂÖ´", "‰πù", "ÂçÅ", "Áôæ", "ÂçÉ", "‰∏ä", "‰∏ã", "Â∑¶", "Âè≥", "Â§ß", "Â∞è", "Â§ö", "Â∞ë", "‰∫∫", "Âè£", "Êâã", "Ë∂≥", "ÁõÆ", "ËÄ≥", "ÂøÉ", "È†≠", "Â±±", "Ê∞¥", "Êú®", "Á¶æ", "Âúü", "Êó•", "Êúà", "Â§©", "ÁÅ´", "È¢®", "Èõ®", "Èõª", "Êò•", "Â§è", "Áßã", "ÂÜ¨", "Áà∏", "Â™Ω", "Âì•", "Âßê", "Âºü", "Â¶π", "Áî∑", "Â•≥", "ËÄÅ", "Â∞ë", "Â∏´", "Áîü", "Âèã", "ÂÖ¨", "Â©Ü", "Ê†°", "ÂÆ∂", "ÈñÄ", "Á™ó", "Â∫ä", "Ê§Ö", "Ê°å", "Ááà", "Á≠Ü", "Êõ∏", "Á¥ô", "Áï´", "Ê≠å", "Ëä±", "Ëçâ", "Ê®π", "Ëëâ", "Êûú", "Á±≥", "ËÇâ", "Ë±Ü", "Áâõ", "Áæä", "È¶¨", "Èõû", "Áãó", "Ë≤ì", "È≠ö", "È≥•", "‰∏≠", "Âúã", "È¶ô", "Ê∏Ø", "Âá∫", "ÂÖ•", "Èñã", "Èóú", "‰æÜ", "Âéª", "Âùê", "Á´ã", "Ëµ∞", "Ë∑ë", "Ë∑≥", "È£õ", "ËÅΩ", "Ë™™", "ËÆÄ", "ÂØ´", "Áúã", "Ë¶ã", "Êó©", "Âçà", "Êôö", "Á¥Ö", "ÈªÉ", "Ëóç", "Á∂†", "ÁôΩ", "Èªë", "Èáë", "Êàë", "Áà∂", "ÊØç", "Èõ≤", "ÂñÆ", "Ëªä", "‰ºë", "Áü≥", "ÁöÑ", "ÊòØ", "ÁêÉ", "ÂÅö", "ÊúÉ", "Êúã", "ÂÄë", "Âäõ", "Áéâ", "Áä¨", "Áéã", "Êòé", "Âè§", "Ë°£", "Âºì", "Â∑æ", "Âú∞"];

        let currentWord = "", currentMode = 'practice';
        let practiceCorrect = 0, dictationCorrect = 0, isHintRevealed = false;
        let streak = 0, xp = 0, level = 1;

        const kaitiFont = '"Kaiti TC", "STKaiti", "BiauKai", "Ê•∑È´î", sans-serif';
        const tCanvas = document.getElementById('templateCanvas'), dCanvas = document.getElementById('drawCanvas');
        const tCtx = tCanvas.getContext('2d'), dCtx = dCanvas.getContext('2d');
        let drawing = false;

        // 2. ÂàùÂßãÂåñËã±ÈõÑË≥áÊñô
        function initHero() {
            const name = localStorage.getItem('jovan_hero_name') || "Mystery Explorer";
            const globalXp = localStorage.getItem('jovan_total_xp') || 0;
            document.getElementById('hero-name').innerText = name;
            document.getElementById('global-total-xp').innerText = globalXp;
        }

        // 3. ÂçáÁ¥öÁâàÂÖ®ÁêÉÂä†ÂàÜÂäüËÉΩ (Firebase Sync)
        async function addGlobalXP(amount) {
            let currentXP = parseInt(localStorage.getItem('jovan_total_xp')) || 0;
            let heroName = localStorage.getItem('jovan_hero_name') || "Mystery Explorer";
            
            currentXP += amount;
            localStorage.setItem('jovan_total_xp', currentXP);
            document.getElementById('global-total-xp').innerText = currentXP;

            const msg = document.createElement('div');
            msg.innerText = `+${amount} XP!`;
            msg.style = "position:fixed; top:40%; left:50%; transform:translateX(-50%); font-size:4em; color:#55FF55; text-shadow:3px 3px #000; z-index:9999; pointer-events:none; animation: fadeUp 1.5s forwards;";
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 1500);

            // --- Èõ≤Á´ØÂêåÊ≠• ---
            try {
                await setDoc(doc(db, "leaderboard", heroName), {
                    name: heroName,
                    xp: currentXP,
                    lastUpdate: new Date()
                }, { merge: true });
                console.log("Cloud Sync Success!");
            } catch (e) {
                console.error("Cloud Sync Failed: ", e);
            }
        }

        function toggleTooltip() {
            const content = document.getElementById('tooltip-content');
            content.style.display = (content.style.display === 'block') ? 'none' : 'block';
        }

        function setMode(mode) { currentMode = mode; initGame(); }
        
        function speakWord() { 
            if (!currentWord) return; 
            const msg = new SpeechSynthesisUtterance(currentWord); 
            msg.lang = 'zh-HK'; msg.rate = 0.7; 
            window.speechSynthesis.speak(msg); 
        }
        
        function revealHint() { 
            if (currentMode === 'dictation') { 
                document.getElementById('targetWord').innerText = currentWord; 
                document.getElementById('targetWord').style.color = "#FFFF55"; 
                isHintRevealed = true;
                streak = 0; 
                updateComboUI();
            } 
        }

        function initGame() {
            initHero();
            currentWord = wordBank[Math.floor(Math.random() * wordBank.length)];
            isHintRevealed = false;
            const targetWordEl = document.getElementById('targetWord');
            const tCanvasEl = document.getElementById('templateCanvas');
            if (currentMode === 'dictation') {
                targetWordEl.innerText = "???"; tCanvasEl.style.opacity = "0"; 
                document.getElementById('promptText').innerText = "ËÅΩÈü≥ÈªòÂØ´Ôºö";
                document.getElementById('message').innerText = "ÁùáÂíóÊèêÁ§∫ÂîîË®àÂàÜÂêåÊñ∑ Combo „óéÔºÅ";
            } else {
                targetWordEl.innerText = currentWord; tCanvasEl.style.opacity = "0.15"; 
                document.getElementById('promptText').innerText = "Ë´ãÂØ´Âá∫Ôºö";
                document.getElementById('message').innerText = "Á∑¥ÁøíÊ®°ÂºèÔºåÂä†Ê≤πÔºÅ";
            }
            tCtx.clearRect(0, 0, 320, 320); tCtx.fillStyle = "#cccccc"; tCtx.font = "220px " + kaitiFont; tCtx.textAlign = "center"; tCtx.textBaseline = "middle"; tCtx.fillText(currentWord, 160, 165);
            clearCanvas(); setupDrawing();
        }

        function setupDrawing() {
            dCtx.strokeStyle = "#222"; dCtx.lineWidth = 18; dCtx.lineCap = "round"; dCtx.lineJoin = "round";
            const getPos = (e) => {
                const rect = dCanvas.getBoundingClientRect();
                const cx = (e.clientX || (e.touches && e.touches[0].clientX));
                const cy = (e.clientY || (e.touches && e.touches[0].clientY));
                return { x: cx - rect.left, y: cy - rect.top };
            };
            const start = (e) => { drawing = true; const p = getPos(e); dCtx.beginPath(); dCtx.moveTo(p.x, p.y); };
            const move = (e) => { if (!drawing) return; const p = getPos(e); dCtx.lineTo(p.x, p.y); dCtx.stroke(); if(e.cancelable) e.preventDefault(); };
            const stop = () => { drawing = false; };
            dCanvas.onmousedown = dCanvas.ontouchstart = start; window.onmousemove = window.ontouchmove = move; window.onmouseup = window.ontouchend = stop;
        }

        function clearCanvas() { dCtx.clearRect(0, 0, 320, 320); document.getElementById('steve-reward').classList.remove('show-steve'); }

        function checkWriting() {
            const tD = tCtx.getImageData(0, 0, 320, 320).data, dD = dCtx.getImageData(0, 0, 320, 320).data;
            let tP = 0, mP = 0;
            for (let i = 3; i < tD.length; i += 4) { if (tD[i] > 10) { tP++; if (dD[i] > 10) mP++; } }
            const score = (mP / tP) * 100;
            const threshold = (currentMode === 'dictation') ? 40 : 60;
            
            if (score >= threshold) {
                document.getElementById('message').innerText = `Â•ΩÂãÅÂëÄÔºÅ${Math.round(score)}% ‰ººÔºÅüíé`;
                document.getElementById('steve-reward').classList.add('show-steve');
                
                if (currentMode === 'dictation') {
                    if (!isHintRevealed) {
                        dictationCorrect++;
                        document.getElementById('dictationCount').innerText = dictationCorrect;
                        streak++; 
                        addGlobalXP(3); // ËÅΩÈªòÊ®°Âºè +3 XP
                    } else {
                        document.getElementById('message').innerText += " (ÁùáÂíóÊèêÁ§∫ÂîîË®àÂàÜ)";
                        streak = 0;
                    }
                } else {
                    practiceCorrect++;
                    document.getElementById('practiceCount').innerText = practiceCorrect;
                    streak = 0; 
                    addGlobalXP(1); // Á∑¥ÁøíÊ®°Âºè +1 XP
                }

                xp += 20;
                if (xp >= 100) { level++; xp = 0; document.getElementById('xp-text').innerText = "LEVEL " + level + " UP!"; setTimeout(() => document.getElementById('xp-text').innerText = "LEVEL " + level, 2000); }
                
                updateXPUI();
                updateComboUI();
                if (streak >= 5) triggerTNT();
                
                speakWord();
                setTimeout(() => { if(confirm("Â§ßÂãùÂà©ÔºÅ‰∏ã‰∏ÄÂÄãÔºü")) initGame(); }, 1200);
            } else {
                document.getElementById('message').innerText = `Âæó ${Math.round(score)}%... ÂÜçË©¶‰∏ãÔºÅ`;
                streak = 0;
                updateComboUI();
            }
        }

        function updateXPUI() { document.getElementById('xp-bar').style.width = xp + "%"; }

        function updateComboUI() {
            const tntBox = document.getElementById('tnt-box');
            if (streak > 0) {
                tntBox.style.display = 'block';
                document.getElementById('comboText').innerText = "COMBO x" + streak;
            } else {
                tntBox.style.display = 'none';
            }
        }

        function triggerTNT() {
            const tnt = document.getElementById('tntImg');
            tnt.classList.add('exploding');
            document.getElementById('message').innerText = "üí• BOOM! 5-COMBO ÁçéÂãµÔºÅ üí•";
            spawnDiamonds();
            addGlobalXP(5); // TNT È°çÂ§ñ +5 XP
            setTimeout(() => { tnt.classList.remove('exploding'); streak = 0; updateComboUI(); }, 1000);
        }

        function spawnDiamonds() {
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const d = document.createElement('div');
                    d.innerHTML = "üíé"; d.style.position = "fixed"; d.style.top = "-50px";
                    d.style.left = Math.random() * 100 + "vw"; d.style.fontSize = "30px";
                    d.style.zIndex = "3000"; d.style.transition = "transform 2s linear, opacity 2s";
                    document.body.appendChild(d);
                    setTimeout(() => { d.style.transform = "translateY(110vh) rotate(360deg)"; d.style.opacity = "0"; }, 100);
                    setTimeout(() => d.remove(), 2500);
                }, i * 100);
            }
        }

        // 4. ÈáçË¶ÅÔºöÊõùÈú≤ Function ÁïÄ Window Ê®ôË®ò
        window.toggleTooltip = toggleTooltip;
        window.setMode = setMode;
        window.speakWord = speakWord;
        window.revealHint = revealHint;
        window.initGame = initGame;
        window.clearCanvas = clearCanvas;
        window.checkWriting = checkWriting;
        window.onload = initGame;

    </script>
</body>
</html>